# 第一章节：路由器配置与网络安全设置

在开始部署任何 NFX 服务之前，请确保您已满足以下前置条件。这些准备工作对于后续的部署和运行至关重要。

## 前置条件检查

在开始配置之前，请确认以下几点：

1. **网络环境确认**
   - 确保您所在地区具备稳定的互联网接入服务
   - 已配置并正常工作的 WiFi 路由器或光猫设备
   - 了解您的网络拓扑结构（公网 IP 类型、NAT 类型等）

2. **中国用户特殊要求**
   - 如果您位于中国大陆地区，由于运营商网络限制，您需要向网络服务提供商（如中国联通、中国移动、中国电信等）申请开通特定端口
   - 这是实现外网访问您的私有服务器的基础要求
   - 通常需要提供合理的业务用途说明，某些地区可能需要备案

3. **其他地区用户**
   - 如果您位于其他有互联网接入的地区，通常可以直接进行配置
   - 建议先确认您的网络服务提供商是否对入站连接有限制

## 路由器配置指南

本指南以 Telus 光猫（ONU - Optical Network Unit）为例进行说明。不同品牌和型号的路由器界面可能略有差异，但核心配置项和原理相同。

### 1. 访问路由器管理界面

首先，您需要登录到路由器的管理控制面板。通常可以通过以下方式访问：

- 在浏览器中输入路由器的默认网关地址（常见的有 `192.168.1.1`、`192.168.0.1`、`10.0.0.1` 等）
- 使用管理员账号和密码登录
- 具体操作界面请参考下图（参考截图：`../../images/ONU_Dashboard.png`）

![ONU Dashboard](../../images/ONU_Dashboard.png)

### 2. 防火墙安全配置

防火墙是保护您网络的第一道防线，正确的配置至关重要。在路由器管理界面中找到防火墙或安全设置部分（参考截图：`../../images/ONU_Firewall.png`）。

![ONU Firewall](../../images/ONU_Firewall.png)

#### ⚠️ 关键步骤：禁用 DMZ 功能

**重要：DMZ（Demilitarized Zone）功能必须保持关闭状态！**

##### 为什么必须禁用 DMZ？

DMZ 功能的工作原理是将所有来自公网的、未能匹配其他端口转发规则的流量，直接转发到指定的内网设备。这等同于将该设备完全暴露在公网环境中，绕过所有防火墙保护。

##### Docker 防火墙规则的优先级问题

根据 Docker 官方文档：
- [Docker 数据包过滤和防火墙](https://docs.docker.com/engine/network/packet-filtering-firewalls/)
- [Docker 端口发布和映射](https://docs.docker.com/engine/network/port-publishing/)

Docker 的设计哲学是优先保证容器的连通性，而非提供安全隔离。当您在 Docker Compose 文件中使用 `ports` 配置项（或使用 `-p` / `--publish` 参数）发布容器端口时，Docker 会自动在宿主机上创建和管理底层的防火墙规则（iptables 或 nftables）。

这些规则通过 NAT（网络地址转换）、端口映射和转发机制，确保发布的端口默认对宿主机和外部网络可访问。因此，Docker 官方文档明确指出：**"Publishing container ports is insecure by default"**（默认情况下，发布容器端口是不安全的）。

Docker 创建的防火墙规则主要目的是：
- 实现容器间的网络隔离
- 保障端口连通性
- **而非提供基于源地址、子网或访问策略的安全控制**

传统系统级防火墙（如 NAS 内置防火墙、ufw、firewalld 等）的规则通常在数据包已经被 Docker 的 NAT 规则处理之后才生效，因此无法有效拦截对已发布容器端口的访问。

**核心要点：**
- Docker 容器的防火墙规则优先级高于 NAS 系统的防火墙规则
- 一旦端口通过 Docker 发布，系统级防火墙实际上已无法有效保护
- 基于此，我们建议将安全边界提升到网络入口层，而非依赖容器或系统级防火墙

##### 配置建议总结

基于以上分析，我们强烈建议：

- ✅ **DMZ 功能必须关闭** - 避免将内网设备完全暴露
- ✅ **不在 NAS 上配置防火墙规则** - 由于优先级问题，配置也无效
- ✅ **在路由器/光猫层面进行访问控制** - 这是最有效的安全边界

### 3. 配置端口转发规则

端口转发是将公网流量路由到内网设备的关键配置。在路由器管理界面中找到端口转发或虚拟服务器设置（参考截图：`../../images/ONU_PortForwarding.png`）。

![ONU Port Forwarding](../../images/ONU_PortForwarding.png)

#### 必需的端口配置

以下端口是运行 NFX 服务所必需的：

- **端口 80（HTTP）** - 必需
  - 用于 HTTP 流量和 HTTP 到 HTTPS 的重定向
  - Let's Encrypt 证书验证（HTTP-01 挑战）也依赖此端口

- **端口 443（HTTPS）** - 必需
  - 用于 HTTPS 加密流量
  - 所有生产环境服务应通过此端口提供

#### 其他可选端口

根据您部署的具体服务，可能还需要开放其他端口：

- 数据库管理界面端口（如 phpMyAdmin、pgAdmin）
- 其他业务服务的特定端口
- 监控和管理工具端口

**建议：** 仅在确实需要时开放额外端口，遵循最小权限原则。

## 安全策略说明

### 推荐方案：在路由器层面实施访问控制

由于 Docker 对宿主机防火墙规则的优先处理，我们强烈推荐以下安全策略：

#### 方案一：路由器/光猫层面控制（推荐）⭐

**优势：**
- 🚀 **实施便捷** - 在单一入口点进行统一管理
- 💰 **成本最低** - 无需额外硬件设备
- 🛡️ **效果最佳** - 在网络边界处实施安全策略
- 📊 **管理简单** - 集中管理所有网络规则

**实施方式：**
通过路由器/光猫的防火墙规则和端口转发配置，在数据包进入内网之前就进行访问控制。这样可以：
- 限制特定 IP 地址段的访问
- 设置访问时间限制
- 记录访问日志
- 阻止恶意流量

#### 方案二：双 NAS 架构（备选）

如果您需要更严格的隔离，可以考虑：

- **转发 NAS** - 作为网关和反向代理，负责处理所有入站流量
- **主 NAS** - 运行实际业务服务，仅与转发 NAS 通信

**适用场景：**
- 对安全性有极高要求的场景
- 需要物理隔离的环境
- 有额外硬件资源的情况

#### 其他技术方案

虽然技术上可以通过以下方式实现更精细的控制：
- 配置 Docker 的 DOCKER-USER 链进行自定义规则
- 使用 Docker 网络策略（Network Policies）
- 配置容器级别的安全组

但考虑到实施复杂度、维护成本和实际效果，我们更推荐方案一。

---

**完成路由器配置后，您的网络环境已准备好，可以进入下一章节进行 NAS 系统的配置。**
